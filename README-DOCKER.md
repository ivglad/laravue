# Руководство по работе с Docker Compose конфигурациями

## Структура конфигурации

Система использует несколько конфигурационных файлов Docker Compose для различных окружений:

1. `docker-compose.yml` - базовая конфигурация, содержит общие настройки для всех окружений
2. `docker-compose.override.yml` - автоматически применяемая конфигурация для разработки
3. `docker-compose.prod.yml` - конфигурация для продакшн-окружения

## Переменные окружения

Система использует различные переменные окружения для гибкой настройки:

```
# Основные переменные
DOCKER_PROJECT_NAME             # Имя проекта для префикса контейнеров
HOST_FRONTEND_PORT              # Основной порт для фронтенда
HOST_BACKEND_PORT               # Основной порт для бэкенда
HOST_DB_PORT                    # Основной порт для базы данных

# Переменные для разработки
HOST_FRONTEND_PORT_DEV          # Порт для фронтенда в режиме разработки
HOST_BACKEND_PORT_DEV           # Порт для бэкенда в режиме разработки
HOST_DB_PORT_DEV                # Порт для базы данных в режиме разработки
```

Переменные с суффиксом `_DEV` применяются только в окружении разработки через конфигурацию `docker-compose.override.yml`.

## Базовые команды

### Для разработки

```bash
# Стандартный запуск для разработки (автоматически подключает docker-compose.override.yml)
docker-compose up -d

# С явным указанием конфигурации для разработки
docker-compose -f docker-compose.yml -f docker-compose.override.yml up -d
```

### Для продакшн-окружения

```bash
# Запуск с конфигурацией для продакшена
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# Проверка конфигурации перед запуском
docker-compose -f docker-compose.yml -f docker-compose.prod.yml config
```

## Масштабирование сервисов

В продакшн-конфигурации для некоторых сервисов установлены параметры масштабирования:

```bash
# Масштабирование nginx в продакшене
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --scale nginx=2
```

## Особенности разных окружений

### Разработка (Development)

- Монтирование кода в контейнеры для разработки
- Включен режим отладки
- Порты доступны на локальной машине (используются переменные с суффиксом `_DEV`)

### Продакшн (Production)

- Код запускается только из образов, без монтирования внешних директорий
- Отключен режим отладки
- Настроены репликации для высокой доступности
- Порты настроены для продакшн-окружения (80/443)

## Изменение конфигурации существующих контейнеров

```bash
# Для применения изменений в конфигурации без пересоздания контейнеров:
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-recreate

# Для пересоздания только измененных сервисов:
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --no-deps <service_name>
```

## Рекомендации

1. **Всегда проверяйте конфигурацию** перед запуском в продакшн:

   ```bash
   docker-compose -f docker-compose.yml -f docker-compose.prod.yml config
   ```

2. **Используйте диапазоны версий образов** для избежания несовместимостей при обновлениях.

3. **Создавайте резервные копии томов** перед важными обновлениями:

   ```bash
   docker volume backup db db-backup-$(date +%Y%m%d)
   ```

4. **Обращайте внимание на порядок указания файлов** при объединении конфигураций - файлы, указанные позже, переопределяют предыдущие настройки.

## Расширение системы

### Добавление нового сервиса

1. Добавьте сервис в базовый `docker-compose.yml`
2. При необходимости добавьте специфические настройки в файлы окружений
3. Не забудьте настроить сети для корректного взаимодействия сервисов

### Настройка CI/CD

Для интеграции с CI/CD системами используйте команды:

```bash
# Для проверки синтаксиса в CI
docker-compose -f docker-compose.yml -f docker-compose.prod.yml config -q

# Для сборки образов без запуска
docker-compose -f docker-compose.yml -f docker-compose.prod.yml build
```
